# CLAUDE_RU.md

Этот файл предоставляет рекомендации Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Обзор
AutoTrade - это профессиональная система торговли криптовалютами, построенная на архитектуре Domain-Driven Design (DDD). Система выполняет автоматическую торговлю, используя технические индикаторы MACD в сочетании с анализом стакана заявок для принятия интеллектуальных решений.

## Архитектура
Кодовая база следует принципам чистой архитектуры с четким разделением ответственности:

### Основная структура
- **domain/** - Бизнес-логика и сущности
  - **entities/** - Основные бизнес-объекты (Deal, Order, CurrencyPair, Ticker)
  - **services/** - Бизнес-сервисы (TradingService, OrderService, DealService и др.)
  - **factories/** - Паттерны создания объектов
- **application/** - Сценарии использования и сервисы приложения
  - **use_cases/** - Основные торговые рабочие процессы
  - **utils/** - Утилиты приложения, такие как PerformanceLogger
- **infrastructure/** - Внешние интеграции
  - **connectors/** - Подключения к API бирж (интеграция ccxt)
  - **repositories/** - Сохранение данных (реализации в памяти)
- **config/** - Файлы конфигурации
- **binance_keys/** - Хранение API ключей

### Ключевые компоненты
- **TradingService** - Главный оркестратор торговых операций
- **OrderExecutionService** - Обрабатывает реальное размещение ордеров (Issue #19)
- **BuyOrderMonitor** - Мониторит и управляет устаревшими ордерами
- **OrderBookAnalyzer** - Анализирует ликвидность и спред стакана заявок
- **TradingDecisionEngine** - Комбинирует сигналы MACD с данными стакана заявок
- **SignalCooldownManager** - Предотвращает переторговку

## Общие команды разработки

### Запуск системы
```bash
# Основная торговая система
python main.py
```

### Зависимости
Система требует следующие основные зависимости:
```bash
pip install requirements.txt
```

### Конфигурация
- Основная конфигурация: `config/config.json`
- API ключи: каталог `binance_keys/`
- Поддерживает как песочницу, так и производственную среду

## Руководство по разработке

### Паттерны архитектуры кода
- Следуйте принципам DDD: храните бизнес-логику в доменном слое
- Используйте фабрики для создания объектов
- Реализуйте паттерн репозитория для доступа к данным
- Сервисы должны быть без состояния и сосредоточены на единственной ответственности

### Асинхронное программирование
- Использует asyncio для параллельных операций
- WebSocket соединения через ccxt.pro
- Будьте осторожны с границами синхронизации/асинхронности - избегайте ненужных async/await
- Используйте `await asyncio.sleep()` вместо `time.sleep()` в асинхронных контекстах

### Поток торговой логики
1. **Сбор данных**: WebSocket тикеры → TickerService → Репозиторий
2. **Генерация сигналов**: Анализ MACD → Технические сигналы
3. **Анализ стакана заявок**: Валидация спреда/ликвидности → Торговое решение
4. **Исполнение сделок**: OrderExecutionService → API биржи
5. **Мониторинг ордеров**: BuyOrderMonitor → Управление устаревшими ордерами

### Безопасность и управление рисками
- SignalCooldownManager предотвращает переторговку
- Валидация стакана заявок обеспечивает достаточную ликвидность
- Лимиты размера позиции и механизмы стоп-лосса
- Отдельные конфигурации для песочницы/производства

## Ключевые файлы для понимания

### Точки входа
- `main.py` - Основная точка входа приложения с полной торговой настройкой
- `application/use_cases/run_realtime_trading.py` - Основной торговый цикл

### Основная бизнес-логика
- `domain/services/trading_service.py` - Главный торговый оркестратор
- `domain/services/order_execution_service.py` - Реальное размещение ордеров
- `domain/services/orderbook_analyzer.py` - Анализ глубины рынка
- `domain/services/trading_decision_engine.py` - Логика комбинирования сигналов

### Управление данными
- `domain/entities/deal.py` - Сущность торговой сделки
- `domain/entities/order.py` - Сущность ордера с интеграцией биржи
- `infrastructure/repositories/` - Слой сохранения данных

### Внешние интеграции
- `infrastructure/connectors/exchange_connector.py` - Обертка API биржи
- `infrastructure/connectors/pro_exchange_connector.py` - WebSocket коннектор

## Подход к тестированию
- Используйте режим песочницы для разработки (`use_sandbox=True`)
- Тестовые скрипты в файлах sandbox*.py
- Производственное тестирование с `test_prod.py`
- В настоящее время нет формального фреймворка модульного тестирования - полагается на интеграционное тестирование

## Управление конфигурацией
- Конфигурация на основе JSON в `config/config.json`
- Настройки для конкретной среды (песочница/производство)
- API ключи хранятся в отдельных файлах с надлежащей безопасностью
- Параметры анализатора стакана заявок настраиваются

## Соображения производительности
- Кэшированные вычисления индикаторов для предотвращения пересчета
- WebSocket соединения для данных в реальном времени
- Логирование производительности с детальными метриками
- Эффективное по памяти хранение тикеров с ограничениями по размеру

## Заметки о безопасности
- API ключи хранятся в отдельных файлах (не в коде)
- Приватные ключи для аутентификации API
- Отдельные среды песочницы/производства
- Никаких конфиденциальных данных в коде или логах

## Общие проблемы и решения

### Проблемы с WebSocket соединением
- Проверьте сетевое подключение
- Проверьте API ключи и разрешения
- Используйте политику цикла событий для Windows в системах Windows

### Отладка торговой логики
- Мониторьте логи производительности для времени обработки тиков
- Проверьте статус задержки сигнала
- Проверьте состояние стакана заявок перед торговлей
- Просмотрите количество активных сделок и лимиты

### Управление ордерами
- BuyOrderMonitor автоматически обрабатывает устаревшие ордера
- Проверьте подключение к бирже перед размещением ордеров
- Убедитесь в достаточном балансе перед торговлей

## Рабочий процесс разработки
1. Внесите изменения в соответствующие слои домена/инфраструктуры
2. Сначала протестируйте в режиме песочницы
3. Проверьте через скрипты песочницы
4. Обновите конфигурацию при необходимости
5. Протестируйте интеграцию через main.py
6. Используйте производственный режим только после полного тестирования

## Будущая разработка
Система спроектирована для расширяемости:
- Поддержка нескольких валютных пар
- Улучшенная генерация сигналов на основе ML
- REST API для внешнего управления
- Слой сохранения базы данных
- Продвинутые функции управления рисками

Обратитесь к ROADMAP.md и каталогу project_management/ для подробных планов разработки и задач.
