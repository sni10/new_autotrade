name: ðŸ§¾ Auto Versioning

on:
  push:
    branches:
      - dev
      - stage
      - release/*
      - main

jobs:
  versioning:
    runs-on: ubuntu-latest

    steps:
      - name: â¬‡ï¸ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: âš™ï¸ Set version variables
        id: vars
        run: |
          # ðŸ‘· BUILD = ÐºÐ¾Ð¼Ð¼Ð¸Ñ‚Ñ‹ Ð² dev, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… Ð½ÐµÑ‚ Ð² main, Ð±ÐµÐ· merge
          BUILD=$(git log origin/main..origin/dev --no-merges --oneline | wc -l)

          # ðŸ” STAGE = Ð¼ÐµÑ€Ð¶Ð¸ Ð¸Ð· dev Ð² stage
          STAGE=$(git log origin/dev..origin/stage --merges --oneline | wc -l)

          # ðŸ§ª MINOR = Ð¼ÐµÑ€Ð¶Ð¸ Ð¸Ð· release/* Ð² main
          MINOR=$(git log origin/release..origin/main --merges --oneline | wc -l)

          # ðŸ§  MAJOR â€” Ñ€ÑƒÑ‡Ð½Ð¾Ð¹, Ñ„Ð¸ÐºÑÐ¸Ñ€ÑƒÐµÐ¼ Ð² ÑÑ‚Ð¾Ð¼ action-Ðµ
          MAJOR=3

          echo "MAJOR=$MAJOR" >> $GITHUB_OUTPUT
          echo "MINOR=$MINOR" >> $GITHUB_OUTPUT
          echo "STAGE=$STAGE" >> $GITHUB_OUTPUT
          echo "BUILD=$BUILD" >> $GITHUB_OUTPUT

      - name: ðŸ·ï¸ Generate version tag
        run: |
          VERSION="${{ steps.vars.outputs.MAJOR }}.${{ steps.vars.outputs.MINOR }}.${{ steps.vars.outputs.STAGE }}.${{ steps.vars.outputs.BUILD }}"
          echo "ðŸ”– Version = $VERSION"
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: ðŸ“Œ Create GitHub Release
        if: github.ref == 'refs/heads/main'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          name: ðŸ“¦ Release v${{ env.VERSION }}
          generate_release_notes: true
